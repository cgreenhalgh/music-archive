<!DOCTYPE html>
<html><head>
<meta charset="utf-8"/>
<title>Music archive performance / codes viz</title>
<!-- http://bl.ocks.org/mbostock/7341714 -->
<style>

.stage {
    font-family: sans-serif;
    font-size: 16px;
    fill: black;
}

.stagebox {
  stroke: grey;
  fill: none;
}

.notdefined {
    fill: none;
    stroke: #aaa;
    shape-rendering: crispEdges;
}
.notplayed {
    fill: red;
    stroke: grey;
    shape-rendering: crispEdges;
}
.played {
    fill: black;
    stroke: grey;
    shape-rendering: crispEdges;
}

.next {
   fill: none;
}

</style>
</head><body>
<p>Reading file as generated by logs2codes (use parameter f=...)</p>
<svg class="chart"></svg>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var urlParams = null;
function getParameter(p) {
  if (urlParams==null) {
    var pl     = /\+/g;  
    // Regex for replacing addition symbol with a space
    var search = /([^&=]+)=?([^&]*)/g;
    var decode = function(s) { return decodeURIComponent(s.replace(pl, " ")); }
    var query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
      urlParams[decode(match[1])] = decode(match[2]);
    return urlParams[p];
  }
}

var filename = getParameter("f");
if (!filename)
  filename = "codes_triggered_viz.json";
console.log("Reading file "+filename);

//Define the div for the tooltip
var div = d3.select("body").append("div")	
 .attr("class", "tooltip")				
 .style("opacity", 0);

d3.json(filename, function(error, data) {
  if (error)  
    alert("Error reading file "+filename+": "+error);

  console.log('read '+data.performances.length+' performances, '+data.stages.length+' stages');
  
var ICON_SIZE = 12,
    LANE_SIZE = 50,
    TITLE_SIZE = 24;
var WIDTH = 1500,
    PADDING = 20,
    HEIGHT = 2*LANE_SIZE+3*(TITLE_SIZE+ICON_SIZE*data.performances.length)+2*PADDING;
var X_NUM = 10, Y_NUM = 3, X_PITCH = WIDTH / X_NUM;

//var xScale = d3.scale.linear()
//    .range([padding,width]);

//var yScale = d3.scale.linear()
//    .range([height-padding-10, 10]);

var chart = d3.select(".chart")
    .attr("width", WIDTH)
    .attr("height", HEIGHT);

//  xScale.domain([data.metadata.fromtime, data.metadata.totime]);
//  yScale.domain([0,data.users.length]);

  var colScale = d3.scale.linear()
    .range(["red","blue"]);
  colScale.domain([0,data.performances.length-1]);

  chart.selectAll("text.stage")
  .data(data.stages)
  .enter().append("text")
  .classed("stage", true)
  .attr("x", function(d,i) { return PADDING+d.level*X_PITCH+X_PITCH/2+ICON_SIZE*d.codes.length/2 })
  .attr("y", function(d,i) { return PADDING+d.path*(LANE_SIZE+TITLE_SIZE+ICON_SIZE*data.performances.length)+TITLE_SIZE-ICON_SIZE })
  .attr("text-anchor", "middle")
  .text(function(d,i) { return d.title; })

  chart.selectAll("rect.stagebox")
  .data(data.stages)
  .enter().append("rect")
  .classed("stagebox", true)
  .attr("x", function(d,i) { return PADDING+d.level*X_PITCH+X_PITCH/2-ICON_SIZE/2 })
  .attr("y", function(d,i) { return PADDING+d.path*(LANE_SIZE+TITLE_SIZE+ICON_SIZE*data.performances.length)+TITLE_SIZE-ICON_SIZE/2 })
  .attr("width", function(d,i) { return ICON_SIZE+ICON_SIZE*d.codes.length })
  .attr("height", function(d,i) { return ICON_SIZE*data.performances.length+ICON_SIZE });
  
  var codes = [];
  for (var si in data.stages) {
	var stage = data.stages[si];
	for (var ci=0; ci<stage.codes.length; ci++) {
		var code = stage.codes[ci];
		for (var pi=0; pi<data.performances.length; pi++) {
			if (code.performance_code[data.performances[pi].id]!==undefined) {
				var performance_code = code.performance_code[data.performances[pi].id];
				var pcode = { id: code.id, type: code.type, cix: ci, pix: pi, path: stage.path, level: stage.level,
					played: performance_code.played }
				codes.push(pcode);
			}
		}
	}
  }
  
  var vcodes = chart.selectAll("g.code")
  .data(codes)
  .enter().append("g")
  .classed("code", true)
  .attr("transform", function(d, i) { return "translate(" + (PADDING+d.level*X_PITCH+X_PITCH/2+ICON_SIZE*d.cix) + ", " + 
	  (PADDING+d.path*(LANE_SIZE+TITLE_SIZE+ICON_SIZE*data.performances.length)+TITLE_SIZE+ICON_SIZE*d.pix)+ ")"; });

  vcodes.append("path")
  .classed("notplayed", function(d,i) { console.log("code", i, d); return !d.played && d.played!==undefined})
  .classed("notdefined", function(d,i) { console.log("code", i, d); return d.played===undefined })
  .classed("played", function(d,i) { return d.played })
  .attr("fill", function(d,i) { return d.played ? "red" : "black"})
  .attr("d", function(d, i) { if ("challenge"==d.type || "choice"==d.type) return "M6 0 L12 6 L6 12 L0 6 L6 0";
    else if ("approach"==d.type) return "M0 6 L12 0 L12 12 L0 6";
    else return "M0 0 L12 6 L0 12 L0 0" });
  
  var transitions = []
  for (var si in data.stages) {
	  var from = data.stages[si];
	  for (var pix=0; pix<data.performances.length; pix++) {
		  var performance = data.performances[pix];
		  if (from.performance_next[performance.id]!==undefined) {
			  var next_id = from.performance_next[performance.id];
			  var next = data.stages.find(function(s) { return next_id == s.id; });
			  if (!next) 
				  console.log('could not find next stage '+next_id);
			  else {
				  var transition = { from_path: from.path, from_level: from.level, to_path: next.path, to_level: next.level, pix: pix, from_codes: from.codes.length }
				  transitions.push(transition);
			  }
		  }
	  }
  }
  chart.selectAll("path.next")
  .data(transitions)
  .enter().append("path")
  .classed("next",true)
  .attr("stroke", function(d,i) { return colScale(d.pix); })
  .attr("d", function(d,i) { return "M"+
  	((PADDING+d.from_level*X_PITCH+X_PITCH/2+ICON_SIZE*d.from_codes))+" "+
  	((PADDING+d.from_path*(LANE_SIZE+TITLE_SIZE+ICON_SIZE*data.performances.length)+TITLE_SIZE+ICON_SIZE*d.pix+ICON_SIZE/2))+" C"+
  	((PADDING+d.from_level*X_PITCH+X_PITCH/2+ICON_SIZE*d.from_codes)+120)+" "+
  	((PADDING+d.from_path*(LANE_SIZE+TITLE_SIZE+ICON_SIZE*data.performances.length)+TITLE_SIZE+ICON_SIZE*d.pix+ICON_SIZE/2))+" "+
  	((PADDING+d.to_level*X_PITCH+X_PITCH/2)-120)+" "+
  	((PADDING+d.to_path*(LANE_SIZE+TITLE_SIZE+ICON_SIZE*data.performances.length)+TITLE_SIZE+ICON_SIZE*d.pix+ICON_SIZE/2))+" "+
  	((PADDING+d.to_level*X_PITCH+X_PITCH/2))+" "+
  	((PADDING+d.to_path*(LANE_SIZE+TITLE_SIZE+ICON_SIZE*data.performances.length)+TITLE_SIZE+ICON_SIZE*d.pix+ICON_SIZE/2)) });
  
/*
  chart.selectAll("line.marker")
    .data(data.metadata.markers)
    .enter().append("line")
       .classed("marker", true)
      .attr("x1", function(d,i) { return xScale(d.time); })
      .attr("y1", function(d,i) { return yScale(0); })
      .attr("x2", function(d,i) { return xScale(d.time); })
      .attr("y2", function(d,i) { return yScale(data.users.length); })
  
  chart.selectAll("line.lane")
    .data(data.users)
    .enter().append("line")
       .classed("marker", true)
      .attr("x1", 0)
      .attr("y1", function(d,i) { return yScale(d.ix+1); })
      .attr("x2", width)
      .attr("y2", function(d,i) { return yScale(d.ix+1); })
  
  chart.selectAll("text.user")
     .data(data.users)
     .enter().append("text")
     .classed("user", true)
     .attr("x", 5)
     .attr("y", function(d,i) { return yScale(d.ix+0.5) })
     .text(function(d,i) { return "U"+d.userid; })
     
  var views = chart.selectAll("g.view")
      .data(data.views)
    .enter().append("g")
      .classed('view',true)
      .attr("transform", function(d, i) { return "translate(" + xScale(d.time) + ", " + yScale(d.userix+0.5) + ")"; });

//  function page2y(pageix) { return pageix/data.pages.length; }
  function page2y(pageix) { return (pageix % 8)/8; }
//  function page2color(pageix) { return colScale(pageix); }
  var COLORS = ["black","#800000","#ff0000","#ff8000","#ffff00","#80ff00","#00ff00","#008000","#0000ff","#000080","#0000a0","#000040","#0000c0","#0000060"]
  function page2color(pageix) { return COLORS[pageix % COLORS.length]; }

  views.append("line")
      .classed("hidden",function(d,i) { return !d.navigation; })
      .attr("stroke", function(d,i) { return page2color( d.pageix ); })
      .attr("x1", 0)
      // no join from last?
      .attr("y1", function(d,i) { return yScale(d.userix+0.15+0.7*page2y(d3.min([d.pageix]))-0.15)-yScale(d.userix+0.5); })
      .attr("x2", 0)
      .attr("y2", function(d,i) { return yScale(d.userix+0.15+0.7*page2y(d3.max([d.pageix]))+0.15)-yScale(d.userix+0.5); })
        .on("mouseover", function(d) {		
            div.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div	.html(data.pages[d.pageix].page)	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 14) + "px");	
            })					
        .on("mouseout", function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });

  views.append("line")
      //.classed("timeline",true)
      .attr("stroke", function(d,i) { return page2color( d.pageix ); })
      .attr("x1", 0)
      .attr("y1", function(d,i) { return yScale(d.userix+0.15+0.7*page2y(d.pageix))-yScale(d.userix+0.5); })
      .attr("x2", function(d,i) { return xScale(d.time+d.duration)-xScale(d.time); })
      .attr("y2", function(d,i) { return yScale(d.userix+0.15+0.7*page2y(d.pageix))-yScale(d.userix+0.5); })
        .on("mouseover", function(d) {		
            div.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div	.html(data.pages[d.pageix].page)	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 14) + "px");	
            })					
        .on("mouseout", function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });

  var xAxis = d3.svg.axis()
                  .scale(xScale)
                  .orient("bottom");
  chart.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + (height-padding) + ")")
      .call(xAxis);

  var yAxis = d3.svg.axis()
                  .scale(yScale)
                  .orient("left");
  chart.append("g")
      .attr("class", "axis")
      .attr("transform", "translate("+padding+",0)")
      .call(yAxis);
*/
});
</script>
</body></html>
